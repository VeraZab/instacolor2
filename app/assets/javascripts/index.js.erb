 function sendDataRequest(){
 	var string = document.getElementById('formstyle').value;
 	var param;
 	if(string.charAt(0)==="@"){
 		param = string.substring(1);
 	} else{
 		param = string;
 	}
 	var once = 0;
 	var url = '/search?utf8=âœ“&q='+param;
 	var xhr = new XMLHttpRequest();
 	xhr.onreadystatechange = function() {
 		if (xhr.readyState === 4 && xhr.status === 200) {
 			createParentComponent(JSON.parse(xhr.responseText));
 		} else if(xhr.status === 500){
 			if(once === 0) {
 				type(": sorry can't find that user", 0);
 				once=1;
 			}
 		}
 	};
 	xhr.open('GET', url, true);
 	xhr.setRequestHeader("Accept", "text/javascript");
 	xhr.send(); 
 }

 function createParentComponent(array){	
 	if(!array.length){
 		type(': sorry, I can\'t see your pictures', 0);
 	};

	var dimPar;
	 if(array.length<12){
	 	array.length = array.length;
	 	if(window.innerWidth<509){
	 		dimPar = '30%';
	 	}else if(window.innerWidth>=509&&window.innerWidth<=900){
	 		dimPar = '22%';
	 	}else if (window.innerWidth>900){
	 		dimPar = '15%';
	 	}
	 }else if(array.length>=12&&array.length<48){
	 	array.length = 12;
	 	if(window.innerWidth<509){
	 		dimPar = '30%';
	 	}else if(window.innerWidth>=509&&window.innerWidth<=900){
	 		dimPar = '22%';
	 	}else if (window.innerWidth>900){
	 		dimPar = '15%';
	 	}
	 }else if (array.length>=48){
	 	array.length = 48;
	 	if(window.innerWidth<509){
	 		dimPar = '30%';
	 	}else if(window.innerWidth>=509&&window.innerWidth<=900){
	 		dimPar = '14%';
	 	}else if (window.innerWidth>900){
	 		dimPar = '8%';
	 	}
	 }

	array.slice(0,array.length).forEach(function(image){
		var parent = document.createElement('div');
		parent.style.width = dimPar;
		parent.style.paddingBottom = dimPar;
		parent.className = 'parent';

		parent.appendChild(createImgandColorDiv(image, dimPar)[1]);
		parent.appendChild(createImgandColorDiv(image, dimPar)[0]);
		document.getElementById('picContainer').appendChild(parent);
	});
};

var COLORS = [];

function createImgandColorDiv(url, dim){
	var dim = (parseFloat(dim)/100)*document.getElementById('picContainer').clientWidth;
	var img = document.createElement('img');
	img.style.height = dim+'px';
    img.style.width = dim+'px';
    img.style.opacity = "0";

	var cdiv=document.createElement('div');
	cdiv.style.height = dim+'px';
    cdiv.style.width = dim+'px';
    cdiv.className = 'cdiv';
	
	img.onload = function(){
		var c = document.getElementsByClassName('cdiv');
		var hsl = getDominantHSLColor(img);
		COLORS.push(hsl);
		cdiv.style.backgroundColor = 'hsl('+hsl[0]+','+hsl[1]+'%,'+hsl[2]+'%)';
		if(COLORS.length===c.length){
			setTimeout(function(){
				type(getAttributes(COLORS), 0);

			}, 2000);
		};
	};

	img.src = url;
	return [img, cdiv];	
}

function displayButton(){
	var button = document.getElementById('startOver');
	button.style.display= 'block';
};

function getDominantHSLColor(image) {
	var colorThief = new ColorThief();
	var color = colorThief.getColor(image);
	var hsl = rgbToHsl(color[0], color[1], color[2]);
	return hsl;
}

function rgbToHsl(r, g, b) {
	r /= 255, g /= 255, b /= 255;
	var max = Math.max(r, g, b), min = Math.min(r, g, b);
	var h, s, l = (max + min) / 2;

	if (max == min) {
	    h = s = 0; 
	} else {
	    var d = max - min;
	    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
	    switch(max){
	        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
	        case g: h = (b - r) / d + 2; break;
	        case b: h = (r - g) / d + 4; break;
	    }
	    h /= 6;
	}
	return [Math.floor(h * 360), Math.floor(s * 100), Math.floor(l * 100)];
}

var COLOR_DEFINITIONS = [{
	name: "Red",
	higherThan: 350,
	lowerThan: 10,
	attributes: ["sensual", "ambitious", "extroverted", "courageous", "egoistic"],
	count: 0
}, {
	name: "Orange",
	higherThan: 10,
	lowerThan: 30,
	attributes: ["social", "vivacious", "unpredictable", "assertive", "inconsistent"],
	count: 0
}, {
	name: "Yellow",
	higherThan: 30,
	lowerThan: 75,
	attributes: ["optimistic", "meticulous", "nerdy", "networker", "snob"],
	count: 0
}, {
	name: "Green",
	higherThan: 75,
	lowerThan: 135,
	attributes: ["caring", "empathetic", "practical", "gracious", "gossip girl"],
	count: 0
}, {
	name: "Turquoise",
	higherThan: 135,
	lowerThan: 190,
	attributes: ["wise", "independent","idealistic", "outspoken", "narcissistic"],
	count: 0
}, {
	name: "Blue",
	higherThan: 190,
	lowerThan: 240,
	attributes: ["harmonious", "trustworthy", "loyal", "sincere", "stubborn"],
	count: 0
}, {
	name: "Purple",
	higherThan: 240,
	lowerThan: 310,
	attributes: ["intuitive", "futuristic", "introspective", "eccentric", "drama queen"],
	count: 0
}, {
	name: "Pink",
	higherThan: 310,
	lowerThan: 350, 
	attributes: ["resourceful", "loving", "generous", "romantic", "naive"],
	count: 0
}];

function getAttributes(colors){
	var attr = [];
	var total = 0;
	
	colors.forEach(function(hsl) {
		if((hsl[1] > 50) && (hsl[2] > 20)){
			total ++;
			for(var x = 0; x<COLOR_DEFINITIONS.length; x++){
				if((hsl[0]<COLOR_DEFINITIONS[x].lowerThan)&&(hsl[0]>=COLOR_DEFINITIONS[x].higherThan)){
					COLOR_DEFINITIONS[x].count ++;
				}
			}
		}
	});

	for(var z = 0; z<COLOR_DEFINITIONS.length; z++){
		COLOR_DEFINITIONS[z].count = Math.floor(((COLOR_DEFINITIONS[z].count)/total)*5)*2;
	}
	
	COLOR_DEFINITIONS.sort(function(a, b){
		return  b.count-a.count;
	});

	for(var x = 0; x<COLOR_DEFINITIONS.length; x++){
		if(COLOR_DEFINITIONS[x].count != 0){
			for(var y = 0; y<COLOR_DEFINITIONS[x].count; y++){
				attr.push(COLOR_DEFINITIONS[x].attributes[y]);
			}
		}
	}

	if(attr.length === 0){
		return ": you're mysterious";
	}else{
		return ": you're "+attr.slice(0,3).join(", ");
	}
};

function type(string, index){
  	var val = string.charAt(index);
  	document.getElementById('formstyle').value += val;

	if (index < string.length) {
		setTimeout(function(){ type(string, index + 1); }, Math.random() * 100);
	}else{
		setTimeout(function(){displayButton();}, 500);
	}
}

function start(){
	var form = document.getElementById('formstyle');
	var picContainer = document.getElementById('picContainer');
	var attrContainer = document.getElementById('attributes');
	var restart = document.getElementById('startOver');

	form.addEventListener('keydown', function(e){
			if(e.keyCode === 13){
				e.preventDefault();
				e.stopPropagation();
				picContainer.innerHTML = '';
				sendDataRequest();
			};	
	});

	restart.addEventListener('click', function(){
		COLORS = [];
		for(var o = 0; o<COLOR_DEFINITIONS.length; o++){
			COLOR_DEFINITIONS[o].count = 0;	
		}
		while(document.images.length){
			var parent = document.images[0].parentNode;
			var parentOfParent = parent.parentNode;
			parentOfParent.removeChild(parent);
		};
		form.value ='@';
		form.focus();
		form.setSelectionRange(1,1);
		restart.style.display = 'none';
	});
}

window.onload = function(){
	start();	
};
	
